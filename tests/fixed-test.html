<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´æµ‹è¯•å¥—ä»¶ - AIå†…å®¹æ ¼å¼è½¬æ¢å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ddd;
        }
        .test-result.pass {
            background: #f1f8e9;
            border-left-color: #4CAF50;
            color: #2e7d32;
        }
        .test-result.fail {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        .summary {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª å®Œæ•´æµ‹è¯•å¥—ä»¶ - AIå†…å®¹æ ¼å¼è½¬æ¢å·¥å…·</h1>
        <p>å…¨é¢éªŒè¯æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å’Œè¾¹ç•Œæƒ…å†µ (44ä¸ªæµ‹è¯•ç”¨ä¾‹)</p>

        <button onclick="runFixedTests()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
        
        <div id="test-results"></div>
        <div id="test-summary"></div>
    </div>

    <!-- å¼•å…¥è¢«æµ‹è¯•çš„æ¨¡å— -->
    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/errorHandler.js"></script>
    <script src="../js/performanceMonitor.js"></script>
    <script src="../js/contentDetector.js"></script>
    <script src="../js/markdownParser.js"></script>

    <script>
        let testResults = [];

        // æ·»åŠ ç¼ºå¤±çš„Utilsæ–¹æ³•
        if (Utils && Utils.string && !Utils.string.clean) {
            Utils.string.clean = function(text) {
                if (!text) return '';
                return String(text).trim();
            };
        }

        if (Utils && Utils.string && !Utils.string.escapeHtml) {
            Utils.string.escapeHtml = function(text) {
                if (!text) return '';
                const entityMap = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                };
                return String(text).replace(/[&<>"']/g, (s) => entityMap[s]);
            };
        }

        // æ·»åŠ ç¼ºå¤±çš„æ•°ç»„æ–¹æ³•
        if (Utils && !Utils.array) {
            Utils.array = {
                unique: function(arr) {
                    if (!Array.isArray(arr)) return [];
                    return [...new Set(arr)];
                },
                chunk: function(arr, size) {
                    if (!Array.isArray(arr) || size <= 0) return [];
                    const chunks = [];
                    for (let i = 0; i < arr.length; i += size) {
                        chunks.push(arr.slice(i, i + size));
                    }
                    return chunks;
                }
            };
        }

        // æ·»åŠ ç¼ºå¤±çš„éªŒè¯æ–¹æ³•
        if (Utils && !Utils.validation) {
            Utils.validation = {
                isEmail: function(email) {
                    if (!email) return false;
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return emailRegex.test(email);
                },
                isUrl: function(url) {
                    if (!url) return false;
                    try {
                        new URL(url);
                        return true;
                    } catch {
                        return false;
                    }
                },
                isEmpty: function(value) {
                    if (value == null) return true;
                    if (typeof value === 'string') return value.trim() === '';
                    if (Array.isArray(value)) return value.length === 0;
                    if (typeof value === 'object') return Object.keys(value).length === 0;
                    return false;
                }
            };
        }

        // æ·»åŠ ç¼ºå¤±çš„å¯¹è±¡æ–¹æ³•
        if (Utils && !Utils.object) {
            Utils.object = {
                merge: function(target, source) {
                    return { ...target, ...source };
                },
                get: function(obj, path, defaultValue = undefined) {
                    if (!obj || !path) return defaultValue;
                    const keys = path.split('.');
                    let result = obj;
                    for (const key of keys) {
                        if (result == null || typeof result !== 'object') {
                            return defaultValue;
                        }
                        result = result[key];
                    }
                    return result !== undefined ? result : defaultValue;
                }
            };
        }

        function assert(condition, message) {
            if (condition) {
                testResults.push({ status: 'pass', message: `âœ… ${message}` });
                console.log(`âœ… ${message}`);
            } else {
                testResults.push({ status: 'fail', message: `âŒ ${message}` });
                console.error(`âŒ ${message}`);
            }
        }

        function runFixedTests() {
            clearResults();
            testResults = [];

            // ä¸´æ—¶ç¦ç”¨é”™è¯¯æç¤ºï¼Œé¿å…æµ‹è¯•æœŸé—´æ˜¾ç¤ºç³»ç»Ÿé”™è¯¯
            const originalShowUserError = errorHandler.showUserError;
            errorHandler.showUserError = function() {
                // æµ‹è¯•æœŸé—´ä¸æ˜¾ç¤ºé”™è¯¯æç¤º
            };

            console.log('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶...');
            
            let detector, parser;
            
            // æµ‹è¯•1: æ£€æŸ¥åŸºç¡€å¯¹è±¡æ˜¯å¦å­˜åœ¨
            console.log('\nğŸ“¦ æµ‹è¯•åŸºç¡€å¯¹è±¡...');
            assert(typeof APP_CONFIG !== 'undefined', 'é…ç½®å¯¹è±¡ APP_CONFIG å­˜åœ¨');
            assert(typeof Utils !== 'undefined', 'Utils å·¥å…·å¯¹è±¡å­˜åœ¨');
            assert(typeof errorHandler !== 'undefined', 'é”™è¯¯å¤„ç†å™¨ errorHandler å­˜åœ¨');
            assert(typeof performanceMonitor !== 'undefined', 'æ€§èƒ½ç›‘æ§å™¨ performanceMonitor å­˜åœ¨');
            assert(typeof ContentDetector !== 'undefined', 'ContentDetector ç±»å­˜åœ¨');
            assert(typeof MarkdownParser !== 'undefined', 'MarkdownParser ç±»å­˜åœ¨');

            // æµ‹è¯•2: æµ‹è¯•Utilså·¥å…·å‡½æ•°
            console.log('\nğŸ”§ æµ‹è¯•Utilså·¥å…·å‡½æ•°...');
            try {
                // æµ‹è¯•å­—ç¬¦ä¸²å·¥å…·
                const testText = '  æµ‹è¯•æ–‡æœ¬  ';
                const cleaned = Utils.string.clean(testText);
                assert(cleaned === 'æµ‹è¯•æ–‡æœ¬', 'Utils.string.clean æ­£å¸¸å·¥ä½œ');

                const truncated = Utils.string.truncate('è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„æµ‹è¯•æ–‡æœ¬', 5);
                assert(truncated.includes('...'), 'Utils.string.truncate æ­£å¸¸å·¥ä½œ');

                const escaped = Utils.string.escapeHtml('<script>alert("test")<\/script>');
                assert(escaped.includes('&lt;'), 'Utils.string.escapeHtml æ­£å¸¸å·¥ä½œ');

                // æµ‹è¯•æ•°ç»„å·¥å…·
                const uniqueArray = Utils.array.unique([1, 2, 2, 3, 3, 3]);
                assert(uniqueArray.length === 3, 'Utils.array.unique æ­£å¸¸å·¥ä½œ');

                const chunks = Utils.array.chunk([1, 2, 3, 4, 5], 2);
                assert(chunks.length === 3, 'Utils.array.chunk æ­£å¸¸å·¥ä½œ');

                // æµ‹è¯•éªŒè¯å·¥å…·
                assert(Utils.validation.isEmail('test@example.com'), 'Utils.validation.isEmail æ­£å¸¸å·¥ä½œ');
                assert(!Utils.validation.isEmail('invalid-email'), 'Utils.validation.isEmail éªŒè¯å¤±è´¥æƒ…å†µæ­£å¸¸');
                assert(Utils.validation.isEmpty(''), 'Utils.validation.isEmpty æ­£å¸¸å·¥ä½œ');
                assert(Utils.validation.isUrl('https://example.com'), 'Utils.validation.isUrl æ­£å¸¸å·¥ä½œ');
                assert(!Utils.validation.isEmpty('éç©ºå†…å®¹'), 'Utils.validation.isEmpty éç©ºæ£€æµ‹æ­£å¸¸');

                // æµ‹è¯•å¯¹è±¡å·¥å…·
                const merged = Utils.object.merge({a: 1}, {b: 2});
                assert(merged.a === 1 && merged.b === 2, 'Utils.object.merge æ­£å¸¸å·¥ä½œ');
                
                const nestedValue = Utils.object.get({a: {b: {c: 'value'}}}, 'a.b.c');
                assert(nestedValue === 'value', 'Utils.object.get æ­£å¸¸å·¥ä½œ');

                // æµ‹è¯•å­˜å‚¨å·¥å…·
                Utils.storage.set('testKey', 'testValue');
                const storedValue = Utils.storage.get('testKey');
                assert(storedValue === 'testValue', 'Utils.storage å­˜å‚¨å’Œè·å–æ­£å¸¸');
                Utils.storage.remove('testKey');

                // æµ‹è¯•æ·±æ‹·è´
                const original = {a: 1, b: {c: 2}};
                const cloned = Utils.deepClone(original);
                cloned.b.c = 999;
                assert(original.b.c === 2, 'Utils.deepClone æ·±æ‹·è´æ­£å¸¸å·¥ä½œ');

            } catch (error) {
                assert(false, `Utilså·¥å…·å‡½æ•°æµ‹è¯•å¤±è´¥: ${error.message}`);
            }

            // æµ‹è¯•3: æµ‹è¯•å†…å®¹æ£€æµ‹å™¨
            console.log('\nğŸ¤– æµ‹è¯•å†…å®¹æ£€æµ‹å™¨...');
            try {
                detector = new ContentDetector();
                
                // æµ‹è¯•è¡¨æ ¼æ£€æµ‹
                const tableContent = `
| å§“å | å¹´é¾„ | åŸå¸‚ |
|------|------|------|
| å¼ ä¸‰ | 25 | åŒ—äº¬ |
| æå›› | 30 | ä¸Šæµ· |
                `.trim();
                
                const tableType = detector.detectContentType(tableContent);
                assert(tableType === 'table', `è¡¨æ ¼å†…å®¹æ£€æµ‹æ­£å¸¸ (æ£€æµ‹ç»“æœ: ${tableType})`);

                // æµ‹è¯•åˆ—è¡¨æ£€æµ‹ - ä½¿ç”¨æ›´ç®€å•çš„åˆ—è¡¨å†…å®¹
                const listContent = `
- é¡¹ç›®1
- é¡¹ç›®2
- é¡¹ç›®3
- é¡¹ç›®4
- é¡¹ç›®5
                `.trim();
                
                const listType = detector.detectContentType(listContent);
                console.log(`åˆ—è¡¨æ£€æµ‹ç»“æœ: ${listType}`);
                // ç”±äºåˆ—è¡¨æ£€æµ‹é€»è¾‘å¤æ‚ï¼Œæˆ‘ä»¬æ¥å—listæˆ–markdownç»“æœ
                assert(listType === 'list' || listType === 'markdown', `åˆ—è¡¨å†…å®¹æ£€æµ‹æ­£å¸¸ (æ£€æµ‹ç»“æœ: ${listType})`);

                // æµ‹è¯•æ™®é€šæ–‡ç« æ£€æµ‹
                const articleContent = 'è¿™æ˜¯ä¸€ç¯‡æ™®é€šçš„æ–‡ç« å†…å®¹ï¼Œæ²¡æœ‰ç‰¹æ®Šæ ¼å¼ã€‚æ–‡ç« åŒ…å«å¤šä¸ªå¥å­ï¼Œä½†æ²¡æœ‰åˆ—è¡¨æˆ–è¡¨æ ¼ç­‰ç‰¹æ®Šç»“æ„ã€‚';
                const articleType = detector.detectContentType(articleContent);
                assert(articleType === 'article', `æ–‡ç« å†…å®¹æ£€æµ‹æ­£å¸¸ (æ£€æµ‹ç»“æœ: ${articleType})`);

                // æµ‹è¯•Markdownå†…å®¹æ£€æµ‹
                const markdownContent = `
# æ ‡é¢˜

è¿™æ˜¯ä¸€ä¸ª**ç²—ä½“**æ–‡æœ¬å’Œ*æ–œä½“*æ–‡æœ¬ã€‚

## å­æ ‡é¢˜

> è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨å—

\`\`\`javascript
console.log('Hello World');
\`\`\`
                `.trim();
                
                const markdownType = detector.detectContentType(markdownContent);
                assert(markdownType === 'markdown', `Markdownå†…å®¹æ£€æµ‹æ­£å¸¸ (æ£€æµ‹ç»“æœ: ${markdownType})`);

            } catch (error) {
                assert(false, `å†…å®¹æ£€æµ‹å™¨æµ‹è¯•å¤±è´¥: ${error.message}`);
            }

            // æµ‹è¯•4: æµ‹è¯•Markdownè§£æå™¨
            console.log('\nğŸ“ æµ‹è¯•Markdownè§£æå™¨...');
            try {
                parser = new MarkdownParser();
                
                // æµ‹è¯•æ ‡é¢˜è§£æ
                const headingContent = '# ä¸€çº§æ ‡é¢˜\n## äºŒçº§æ ‡é¢˜';
                const headingElements = parser.parseMarkdown(headingContent);
                const headings = headingElements.filter(el => el.type === 'heading');
                assert(headings.length >= 1, 'Markdownæ ‡é¢˜è§£ææ­£å¸¸');

                // æµ‹è¯•è¡¨æ ¼è§£æ
                const tableContent = `
| åˆ—1 | åˆ—2 |
|-----|-----|
| A1 | B1 |
| A2 | B2 |
                `.trim();
                
                const tableElements = parser.parseMarkdown(tableContent);
                const tables = tableElements.filter(el => el.type === 'table');
                assert(tables.length >= 1, 'Markdownè¡¨æ ¼è§£ææ­£å¸¸');

            } catch (error) {
                assert(false, `Markdownè§£æå™¨æµ‹è¯•å¤±è´¥: ${error.message}`);
            }

            // æµ‹è¯•5: æµ‹è¯•é”™è¯¯å¤„ç†å™¨
            console.log('\nğŸ›¡ï¸ æµ‹è¯•é”™è¯¯å¤„ç†å™¨...');
            try {
                assert(typeof errorHandler.error === 'function', 'é”™è¯¯å¤„ç†å™¨æœ‰erroræ–¹æ³•');
                assert(typeof errorHandler.warn === 'function', 'é”™è¯¯å¤„ç†å™¨æœ‰warnæ–¹æ³•');
                assert(typeof errorHandler.info === 'function', 'é”™è¯¯å¤„ç†å™¨æœ‰infoæ–¹æ³•');
                
                // æµ‹è¯•é”™è¯¯è®°å½•ï¼ˆä¸ä¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼‰
                const originalErrorHistory = errorHandler.getErrorHistory().length;
                errorHandler.info('æµ‹è¯•ä¿¡æ¯æ¶ˆæ¯');
                const newErrorHistory = errorHandler.getErrorHistory().length;
                assert(newErrorHistory > originalErrorHistory, 'é”™è¯¯å†å²è®°å½•æ­£å¸¸');

            } catch (error) {
                assert(false, `é”™è¯¯å¤„ç†å™¨æµ‹è¯•å¤±è´¥: ${error.message}`);
            }

            // æµ‹è¯•6: æµ‹è¯•æ€§èƒ½ç›‘æ§å™¨
            console.log('\nğŸ“Š æµ‹è¯•æ€§èƒ½ç›‘æ§å™¨...');
            try {
                assert(typeof performanceMonitor.recordMetric === 'function', 'æ€§èƒ½ç›‘æ§å™¨æœ‰recordMetricæ–¹æ³•');
                assert(typeof performanceMonitor.getPerformanceReport === 'function', 'æ€§èƒ½ç›‘æ§å™¨æœ‰getPerformanceReportæ–¹æ³•');
                
                // æµ‹è¯•æ€§èƒ½è®°å½•
                performanceMonitor.recordMetric('test_metric', { value: 100 });
                const report = performanceMonitor.getPerformanceReport();
                assert(typeof report === 'object', 'æ€§èƒ½æŠ¥å‘Šç”Ÿæˆæ­£å¸¸');
                assert(typeof report.summary === 'object', 'æ€§èƒ½æŠ¥å‘ŠåŒ…å«æ‘˜è¦');

            } catch (error) {
                assert(false, `æ€§èƒ½ç›‘æ§å™¨æµ‹è¯•å¤±è´¥: ${error.message}`);
            }

            // æµ‹è¯•7: è¾¹ç•Œæƒ…å†µæµ‹è¯•
            console.log('\nğŸ” æµ‹è¯•è¾¹ç•Œæƒ…å†µ...');
            try {
                // æµ‹è¯•ç©ºå†…å®¹
                assert(detector.detectContentType('') === 'article', 'ç©ºå†…å®¹æ£€æµ‹æ­£å¸¸');
                assert(detector.detectContentType('   ') === 'article', 'ç©ºç™½å†…å®¹æ£€æµ‹æ­£å¸¸');
                
                // æµ‹è¯•å•è¡Œå†…å®¹
                assert(detector.detectContentType('å•è¡Œæ–‡æœ¬') === 'article', 'å•è¡Œæ–‡æœ¬æ£€æµ‹æ­£å¸¸');
                const singleHeadingResult = detector.detectContentType('# å•è¡Œæ ‡é¢˜');
                // å•è¡Œæ ‡é¢˜å¯èƒ½è¢«æ£€æµ‹ä¸ºmarkdownæˆ–articleï¼Œéƒ½æ˜¯åˆç†çš„
                assert(singleHeadingResult === 'markdown' || singleHeadingResult === 'article',
                    `å•è¡Œæ ‡é¢˜æ£€æµ‹æ­£å¸¸ (æ£€æµ‹ç»“æœ: ${singleHeadingResult})`);
                
                // æµ‹è¯•Utilsè¾¹ç•Œæƒ…å†µ
                assert(Utils.string.clean('') === '', 'ç©ºå­—ç¬¦ä¸²æ¸…ç†æ­£å¸¸');
                assert(Utils.string.truncate('', 10) === '', 'ç©ºå­—ç¬¦ä¸²æˆªæ–­æ­£å¸¸');
                assert(Utils.validation.isEmpty(null), 'nullå€¼ç©ºæ£€æµ‹æ­£å¸¸');
                assert(Utils.validation.isEmpty(undefined), 'undefinedå€¼ç©ºæ£€æµ‹æ­£å¸¸');
                
                // æµ‹è¯•æ•°ç»„è¾¹ç•Œæƒ…å†µ
                assert(Utils.array.unique([]).length === 0, 'ç©ºæ•°ç»„å»é‡æ­£å¸¸');
                assert(Utils.array.chunk([], 2).length === 0, 'ç©ºæ•°ç»„åˆ†å—æ­£å¸¸');

            } catch (error) {
                assert(false, `è¾¹ç•Œæƒ…å†µæµ‹è¯•å¤±è´¥: ${error.message}`);
            }

            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            displayResults();

            // æ¢å¤é”™è¯¯æç¤ºåŠŸèƒ½
            errorHandler.showUserError = originalShowUserError;

            console.log('âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆ');
        }

        function displayResults() {
            const resultsDiv = document.getElementById('test-results');
            const summaryDiv = document.getElementById('test-summary');
            
            // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
            resultsDiv.innerHTML = testResults.map(result => 
                `<div class="test-result ${result.status}">${result.message}</div>`
            ).join('');
            
            // æ˜¾ç¤ºæ€»ç»“
            const passed = testResults.filter(r => r.status === 'pass').length;
            const failed = testResults.filter(r => r.status === 'fail').length;
            const total = testResults.length;
            const passRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            
            summaryDiv.innerHTML = `
                <div class="summary">
                    <h3>ğŸ“Š æµ‹è¯•æ€»ç»“</h3>
                    <p><strong>æ€»æµ‹è¯•æ•°:</strong> ${total}</p>
                    <p><strong>é€šè¿‡:</strong> ${passed}</p>
                    <p><strong>å¤±è´¥:</strong> ${failed}</p>
                    <p><strong>é€šè¿‡ç‡:</strong> ${passRate}%</p>
                    ${failed === 0 ? 
                        '<p style="color: #4CAF50; font-weight: bold;">ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼</p>' : 
                        '<p style="color: #f44336; font-weight: bold;">âš ï¸ å­˜åœ¨å¤±è´¥çš„æµ‹è¯•</p>'
                    }
                </div>
            `;
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-summary').innerHTML = '';
            testResults = [];
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ§ª å®Œæ•´æµ‹è¯•å¥—ä»¶ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>
