name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # åŸºç¡€æ£€æŸ¥
  basic-check:
    name: åŸºç¡€æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥æ–‡ä»¶ç»“æ„
      run: |
        echo "æ£€æŸ¥é¡¹ç›®æ–‡ä»¶ç»“æ„..."
        ls -la
        echo "æ£€æŸ¥HTMLæ–‡ä»¶..."
        if [ -f "index.html" ]; then
          echo "âœ… index.html å­˜åœ¨"
        else
          echo "âŒ index.html ä¸å­˜åœ¨"
          exit 1
        fi
        echo "æ£€æŸ¥CSSæ–‡ä»¶..."
        if [ -d "css" ]; then
          echo "âœ… css ç›®å½•å­˜åœ¨"
          ls -la css/
        else
          echo "âŒ css ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "æ£€æŸ¥JSæ–‡ä»¶..."
        if [ -d "js" ]; then
          echo "âœ… js ç›®å½•å­˜åœ¨"
          ls -la js/
        else
          echo "âŒ js ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

    - name: HTMLè¯­æ³•æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥HTMLè¯­æ³•..."
        # ç®€å•çš„HTMLè¯­æ³•æ£€æŸ¥
        if grep -q "<!DOCTYPE html>" index.html; then
          echo "âœ… HTML5 DOCTYPE æ­£ç¡®"
        else
          echo "âŒ ç¼ºå°‘HTML5 DOCTYPE"
          exit 1
        fi

  # åŠŸèƒ½æµ‹è¯•
  functional-test:
    name: åŠŸèƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [basic-check]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
      run: |
        echo "å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨..."
        python -m http.server 8080 &
        sleep 5

    - name: æµ‹è¯•æœåŠ¡å™¨å“åº”
      run: |
        echo "æµ‹è¯•æœåŠ¡å™¨å“åº”..."
        curl -f http://localhost:8080/ || exit 1
        echo "âœ… æœåŠ¡å™¨å“åº”æ­£å¸¸"

    - name: æ£€æŸ¥å…³é”®æ–‡ä»¶å¯è®¿é—®æ€§
      run: |
        echo "æ£€æŸ¥CSSæ–‡ä»¶..."
        curl -f http://localhost:8080/css/styles.css || exit 1
        echo "æ£€æŸ¥JSæ–‡ä»¶..."
        curl -f http://localhost:8080/js/config.js || exit 1
        echo "âœ… å…³é”®æ–‡ä»¶å¯è®¿é—®"

  # å®‰å…¨æ‰«æ
  security:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: [basic-check]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
      run: |
        echo "æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯..."
        # æ£€æŸ¥æ˜¯å¦æœ‰APIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯
        if grep -r "api_key\|secret\|password" --exclude-dir=.git .; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯"
        else
          echo "âœ… æœªå‘ç°æ•æ„Ÿä¿¡æ¯"
        fi

    - name: è¿è¡Œ CodeQL åˆ†æ
      uses: github/codeql-action/init@v2
      with:
        languages: javascript

    - name: æ‰§è¡Œ CodeQL åˆ†æ
      uses: github/codeql-action/analyze@v2

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    name: éƒ¨ç½²åˆ° GitHub Pages
    runs-on: ubuntu-latest
    needs: [basic-check, functional-test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Pages
      uses: actions/configure-pages@v3

    - name: ä¸Šä¼ åˆ° Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: '.'

    - name: éƒ¨ç½²åˆ° Pages
      id: deployment
      uses: actions/deploy-pages@v2

  # é€šçŸ¥
  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
    - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ç½‘ç«™åœ°å€: https://${{ github.repository_owner }}.github.io/ai-content-converter"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥"
        fi
