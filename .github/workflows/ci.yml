name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  actions: read
  pages: write
  id-token: write

jobs:
  # åŸºç¡€æ£€æŸ¥
  basic-check:
    name: åŸºç¡€æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥æ–‡ä»¶ç»“æ„
      run: |
        echo "æ£€æŸ¥é¡¹ç›®æ–‡ä»¶ç»“æ„..."
        ls -la
        echo "æ£€æŸ¥HTMLæ–‡ä»¶..."
        if [ -f "index.html" ]; then
          echo "âœ… index.html å­˜åœ¨"
        else
          echo "âŒ index.html ä¸å­˜åœ¨"
          exit 1
        fi
        echo "æ£€æŸ¥CSSæ–‡ä»¶..."
        if [ -d "css" ]; then
          echo "âœ… css ç›®å½•å­˜åœ¨"
          ls -la css/
        else
          echo "âŒ css ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "æ£€æŸ¥JSæ–‡ä»¶..."
        if [ -d "js" ]; then
          echo "âœ… js ç›®å½•å­˜åœ¨"
          ls -la js/
        else
          echo "âŒ js ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

    - name: HTMLè¯­æ³•æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥HTMLè¯­æ³•..."
        # ç®€å•çš„HTMLè¯­æ³•æ£€æŸ¥
        if grep -q "<!DOCTYPE html>" index.html; then
          echo "âœ… HTML5 DOCTYPE æ­£ç¡®"
        else
          echo "âŒ ç¼ºå°‘HTML5 DOCTYPE"
          exit 1
        fi

  # åŠŸèƒ½æµ‹è¯•
  functional-test:
    name: åŠŸèƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [basic-check]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
      run: |
        echo "å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨..."
        python -m http.server 8080 &
        sleep 5

    - name: æµ‹è¯•æœåŠ¡å™¨å“åº”
      run: |
        echo "æµ‹è¯•æœåŠ¡å™¨å“åº”..."
        curl -f http://localhost:8080/ || exit 1
        echo "âœ… æœåŠ¡å™¨å“åº”æ­£å¸¸"

    - name: æ£€æŸ¥å…³é”®æ–‡ä»¶å¯è®¿é—®æ€§
      run: |
        echo "æ£€æŸ¥CSSæ–‡ä»¶..."
        curl -f http://localhost:8080/css/styles.css || exit 1
        echo "æ£€æŸ¥JSæ–‡ä»¶..."
        curl -f http://localhost:8080/js/config.js || exit 1
        echo "âœ… å…³é”®æ–‡ä»¶å¯è®¿é—®"

  # å®‰å…¨æ‰«æ
  security:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: [basic-check]

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
      run: |
        echo "ğŸ” æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."

        # æ£€æŸ¥å¸¸è§çš„æ•æ„Ÿä¿¡æ¯æ¨¡å¼
        SENSITIVE_PATTERNS=(
          "api_key"
          "secret"
          "password"
          "token"
          "private_key"
          "access_key"
          "auth_token"
        )

        FOUND_SENSITIVE=false

        for pattern in "${SENSITIVE_PATTERNS[@]}"; do
          if grep -r -i "$pattern" --exclude-dir=.git --exclude-dir=archive . 2>/dev/null; then
            echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯: $pattern"
            FOUND_SENSITIVE=true
          fi
        done

        if [ "$FOUND_SENSITIVE" = false ]; then
          echo "âœ… æœªå‘ç°æ•æ„Ÿä¿¡æ¯"
        else
          echo "âŒ å‘ç°æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å¹¶ç§»é™¤"
          exit 1
        fi

    - name: JavaScriptå®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ” JavaScriptå®‰å…¨æ£€æŸ¥..."

        # æ£€æŸ¥å¸¸è§çš„JavaScriptå®‰å…¨é—®é¢˜
        echo "æ£€æŸ¥eval()ä½¿ç”¨..."
        if grep -r "eval(" js/ 2>/dev/null; then
          echo "âš ï¸ å‘ç°eval()ä½¿ç”¨ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©"
        else
          echo "âœ… æœªå‘ç°eval()ä½¿ç”¨"
        fi

        echo "æ£€æŸ¥innerHTMLä½¿ç”¨..."
        if grep -r "innerHTML" js/ 2>/dev/null; then
          echo "âš ï¸ å‘ç°innerHTMLä½¿ç”¨ï¼Œè¯·ç¡®ä¿è¾“å…¥å·²æ¸…ç†"
        else
          echo "âœ… æœªå‘ç°innerHTMLä½¿ç”¨"
        fi

        echo "æ£€æŸ¥document.writeä½¿ç”¨..."
        if grep -r "document.write" js/ 2>/dev/null; then
          echo "âš ï¸ å‘ç°document.writeä½¿ç”¨ï¼Œå¯èƒ½å­˜åœ¨XSSé£é™©"
        else
          echo "âœ… æœªå‘ç°document.writeä½¿ç”¨"
        fi

        echo "âœ… JavaScriptå®‰å…¨æ£€æŸ¥å®Œæˆ"

    - name: ä¾èµ–å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ” ä¾èµ–å®‰å…¨æ£€æŸ¥..."

        # æ£€æŸ¥æ˜¯å¦æœ‰å¤–éƒ¨ä¾èµ–
        if [ -f "package.json" ]; then
          echo "æ£€æŸ¥package.jsonä¾èµ–..."
          if grep -q '"dependencies"' package.json && ! grep -q '{}' package.json; then
            echo "âš ï¸ å‘ç°å¤–éƒ¨ä¾èµ–ï¼Œå»ºè®®è¿›è¡Œå®‰å…¨å®¡è®¡"
          else
            echo "âœ… æ— å¤–éƒ¨ä¾èµ–ï¼Œå®‰å…¨é£é™©è¾ƒä½"
          fi
        fi

        # æ£€æŸ¥CDNé“¾æ¥
        echo "æ£€æŸ¥CDNé“¾æ¥..."
        if grep -r "https://cdn\|http://cdn" . --exclude-dir=.git --exclude-dir=archive 2>/dev/null; then
          echo "âš ï¸ å‘ç°CDNé“¾æ¥ï¼Œè¯·ç¡®ä¿æ¥æºå¯ä¿¡"
        else
          echo "âœ… æœªå‘ç°CDNé“¾æ¥"
        fi

        echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥å®Œæˆ"

  # è´¨é‡æ£€æŸ¥å®Œæˆé€šçŸ¥
  quality-check-complete:
    name: è´¨é‡æ£€æŸ¥å®Œæˆ
    runs-on: ubuntu-latest
    needs: [basic-check, functional-test, security]
    if: always()

    steps:
    - name: è´¨é‡æ£€æŸ¥ç»“æœ
      run: |
        echo "ğŸ“Š è´¨é‡æ£€æŸ¥ç»“æœæ±‡æ€»:"
        echo "   - åŸºç¡€æ£€æŸ¥: ${{ needs.basic-check.result }}"
        echo "   - åŠŸèƒ½æµ‹è¯•: ${{ needs.functional-test.result }}"
        echo "   - å®‰å…¨æ‰«æ: ${{ needs.security.result }}"
        echo ""

        if [ "${{ needs.basic-check.result }}" == "success" ] && \
           [ "${{ needs.functional-test.result }}" == "success" ] && \
           [ "${{ needs.security.result }}" == "success" ]; then
          echo "âœ… æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡ï¼"
          echo "ğŸš€ é¡¹ç›®å·²å‡†å¤‡å¥½éƒ¨ç½²"
        else
          echo "âŒ è´¨é‡æ£€æŸ¥æœªå®Œå…¨é€šè¿‡"
          echo "âš ï¸ è¯·ä¿®å¤å¤±è´¥çš„æ£€æŸ¥é¡¹åå†éƒ¨ç½²"
        fi
