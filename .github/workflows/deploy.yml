name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºä½œä¸š
  build:
    name: æ„å»ºé™æ€æ–‡ä»¶
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: éªŒè¯é¡¹ç›®ç»“æ„
      run: |
        echo "ğŸ” éªŒè¯é¡¹ç›®ç»“æ„..."
        
        # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
        if [ ! -f "index.html" ]; then
          echo "âŒ ç¼ºå°‘ index.html"
          exit 1
        fi
        
        if [ ! -d "css" ]; then
          echo "âŒ ç¼ºå°‘ css ç›®å½•"
          exit 1
        fi
        
        if [ ! -d "js" ]; then
          echo "âŒ ç¼ºå°‘ js ç›®å½•"
          exit 1
        fi
        
        echo "âœ… é¡¹ç›®ç»“æ„éªŒè¯é€šè¿‡"

    - name: æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
      run: |
        echo "ğŸ” æ£€æŸ¥å…³é”®æ–‡ä»¶..."
        
        # æ£€æŸ¥CSSæ–‡ä»¶
        if [ ! -f "css/styles.css" ]; then
          echo "âŒ ç¼ºå°‘ css/styles.css"
          exit 1
        fi
        
        # æ£€æŸ¥JSæ–‡ä»¶
        if [ ! -f "js/config.js" ]; then
          echo "âŒ ç¼ºå°‘ js/config.js"
          exit 1
        fi
        
        if [ ! -f "js/app.js" ]; then
          echo "âŒ ç¼ºå°‘ js/app.js"
          exit 1
        fi
        
        echo "âœ… å…³é”®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

    - name: éªŒè¯HTMLè¯­æ³•
      run: |
        echo "ğŸ” éªŒè¯HTMLè¯­æ³•..."
        
        # æ£€æŸ¥HTML5 DOCTYPE
        if ! grep -q "<!DOCTYPE html>" index.html; then
          echo "âŒ ç¼ºå°‘HTML5 DOCTYPE"
          exit 1
        fi
        
        # æ£€æŸ¥åŸºæœ¬HTMLç»“æ„
        if ! grep -q "<html" index.html; then
          echo "âŒ ç¼ºå°‘htmlæ ‡ç­¾"
          exit 1
        fi
        
        if ! grep -q "<head>" index.html; then
          echo "âŒ ç¼ºå°‘headæ ‡ç­¾"
          exit 1
        fi
        
        if ! grep -q "<body>" index.html; then
          echo "âŒ ç¼ºå°‘bodyæ ‡ç­¾"
          exit 1
        fi
        
        echo "âœ… HTMLè¯­æ³•éªŒè¯é€šè¿‡"

    - name: è®¾ç½®GitHub Pages
      uses: actions/configure-pages@v4

    - name: åˆ›å»ºéƒ¨ç½²ç›®å½•
      run: |
        echo "ğŸ“ åˆ›å»ºéƒ¨ç½²ç›®å½•..."
        mkdir -p _site
        
        # å¤åˆ¶æ‰€æœ‰å¿…è¦æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
        cp index.html _site/
        cp -r css _site/
        cp -r js _site/
        cp LICENSE _site/
        cp README.md _site/
        cp README_EN.md _site/
        
        echo "âœ… éƒ¨ç½²ç›®å½•åˆ›å»ºå®Œæˆ"

    - name: éªŒè¯éƒ¨ç½²æ–‡ä»¶
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²æ–‡ä»¶..."
        ls -la _site/
        
        # ç¡®è®¤å…³é”®æ–‡ä»¶å­˜åœ¨
        if [ ! -f "_site/index.html" ]; then
          echo "âŒ éƒ¨ç½²ç›®å½•ç¼ºå°‘ index.html"
          exit 1
        fi
        
        echo "âœ… éƒ¨ç½²æ–‡ä»¶éªŒè¯é€šè¿‡"

    - name: ä¸Šä¼ Pagesæ„ä»¶
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

  # éƒ¨ç½²ä½œä¸š
  deploy:
    name: éƒ¨ç½²åˆ°GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: éƒ¨ç½²åˆ°GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: éªŒè¯éƒ¨ç½²
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸ“ ç½‘ç«™åœ°å€: ${{ steps.deployment.outputs.page_url }}"
        
        # ç­‰å¾…å‡ ç§’è®©éƒ¨ç½²ç”Ÿæ•ˆ
        sleep 10
        
        # éªŒè¯ç½‘ç«™å¯è®¿é—®æ€§
        echo "ğŸ” éªŒè¯ç½‘ç«™å¯è®¿é—®æ€§..."
        if curl -f -s "${{ steps.deployment.outputs.page_url }}" > /dev/null; then
          echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—®"
        else
          echo "âš ï¸ ç½‘ç«™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ‰èƒ½å®Œå…¨ç”Ÿæ•ˆ"
        fi

  # é€šçŸ¥ä½œä¸š
  notify:
    name: éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ GitHub Pages éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸ“ ç½‘ç«™åœ°å€: https://${{ github.repository_owner }}.github.io/ai-content-converter"
          echo "ğŸ”— ä»“åº“åœ°å€: https://github.com/${{ github.repository }}"
          echo ""
          echo "âœ… éƒ¨ç½²è¯¦æƒ…:"
          echo "   - æ„å»ºçŠ¶æ€: ${{ needs.build.result }}"
          echo "   - éƒ¨ç½²çŠ¶æ€: ${{ needs.deploy.result }}"
          echo "   - æäº¤SHA: ${{ github.sha }}"
          echo "   - åˆ†æ”¯: ${{ github.ref_name }}"
        else
          echo "âŒ GitHub Pages éƒ¨ç½²å¤±è´¥"
          echo ""
          echo "ğŸ” å¤±è´¥è¯¦æƒ…:"
          echo "   - æ„å»ºçŠ¶æ€: ${{ needs.build.result }}"
          echo "   - éƒ¨ç½²çŠ¶æ€: ${{ needs.deploy.result }}"
          echo "   - æäº¤SHA: ${{ github.sha }}"
          echo "   - åˆ†æ”¯: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ’¡ è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi
